{% extends "base.html" %}

{% block title %}Video Call - FEMAI Health{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Video Call Interface -->
        <div class="col-lg-9">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-video me-2"></i>
                        Video Call Interface
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Video Display Area -->
                    <div class="video-container mb-4">
                        <div class="row">
                            <!-- Local Video -->
                            <div class="col-md-6 mb-3">
                                <div class="video-card">
                                    <h6 class="video-label">
                                        <i class="fas fa-user me-2"></i>You
                                    </h6>
                                    <div class="video-wrapper">
                                        <video id="localVideo" autoplay muted playsinline></video>
                                        <div class="video-overlay" id="localVideoOverlay">
                                            <i class="fas fa-user fa-3x text-white"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Remote Video -->
                            <div class="col-md-6 mb-3">
                                <div class="video-card">
                                    <h6 class="video-label">
                                        <i class="fas fa-user-md me-2"></i>Healthcare Professional
                                    </h6>
                                    <div class="video-wrapper">
                                        <video id="remoteVideo" autoplay playsinline></video>
                                        <div class="video-overlay" id="remoteVideoOverlay">
                                            <i class="fas fa-user-md fa-3x text-white"></i>
                                            <p class="mt-2">Connecting...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Call Status -->
                    <div class="call-status text-center mb-4">
                        <div class="status-indicator" id="statusIndicator">
                            <i class="fas fa-circle text-warning" id="statusIcon"></i>
                            <span id="statusText">Ready for Video Call</span>
                        </div>
                        <div class="call-timer mt-2" id="callTimer" style="display: none;">
                            <span class="badge bg-success fs-6" id="timerDisplay">00:00</span>
                        </div>
                    </div>

                    <!-- Call Controls -->
                    <div class="call-controls text-center">
                        <div class="row justify-content-center">
                            <div class="col-auto">
                                <button class="btn btn-success btn-lg rounded-circle me-3" id="startCallBtn" onclick="startVideoCall()">
                                    <i class="fas fa-video"></i>
                                </button>
                                <span class="d-block mt-2">Start Call</span>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-danger btn-lg rounded-circle me-3" id="endCallBtn" onclick="endVideoCall()" style="display: none;">
                                    <i class="fas fa-phone-slash"></i>
                                </button>
                                <span class="d-block mt-2">End Call</span>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-warning btn-lg rounded-circle me-3" id="muteBtn" onclick="toggleMute()" style="display: none;">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <span class="d-block mt-2" id="muteText">Mute</span>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-info btn-lg rounded-circle me-3" id="videoBtn" onclick="toggleVideo()" style="display: none;">
                                    <i class="fas fa-video"></i>
                                </button>
                                <span class="d-block mt-2" id="videoText">Video Off</span>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-secondary btn-lg rounded-circle" id="screenShareBtn" onclick="toggleScreenShare()" style="display: none;">
                                    <i class="fas fa-desktop"></i>
                                </button>
                                <span class="d-block mt-2">Screen Share</span>
                            </div>
                        </div>
                    </div>

                    <!-- Call Quality Indicators -->
                    <div class="call-quality mt-4">
                        <h6><i class="fas fa-signal me-2"></i>Call Quality</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="quality-indicator">
                                    <span>Video Quality:</span>
                                    <div class="progress mt-1">
                                        <div class="progress-bar bg-success" id="videoQuality" style="width: 85%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="quality-indicator">
                                    <span>Audio Quality:</span>
                                    <div class="progress mt-1">
                                        <div class="progress-bar bg-success" id="audioQuality" style="width: 90%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="quality-indicator">
                                    <span>Connection:</span>
                                    <div class="progress mt-1">
                                        <div class="progress-bar bg-info" id="connectionQuality" style="width: 95%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="quality-indicator">
                                    <span>Latency:</span>
                                    <div class="progress mt-1">
                                        <div class="progress-bar bg-warning" id="latencyQuality" style="width: 80%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Call Sidebar -->
        <div class="col-lg-3">
            <!-- Call Information -->
            <div class="card shadow-lg mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Call Info
                    </h6>
                </div>
                <div class="card-body">
                    <div class="info-item mb-3">
                        <strong>Doctor:</strong>
                        <p class="mb-1">Dr. Sarah Johnson</p>
                    </div>
                    <div class="info-item mb-3">
                        <strong>Specialty:</strong>
                        <p class="mb-1">Gynecologist - PCOS Specialist</p>
                    </div>
                    <div class="info-item mb-3">
                        <strong>Available:</strong>
                        <p class="mb-1">Mon-Fri: 9:00 AM - 6:00 PM</p>
                    </div>
                    <div class="info-item">
                        <strong>Call Type:</strong>
                        <p class="mb-1">Video Consultation</p>
                    </div>
                </div>
            </div>

            <!-- Call Logs -->
            <div class="card shadow-lg mb-3">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Call Logs
                    </h6>
                </div>
                <div class="card-body">
                    <div class="call-logs" id="callLogs">
                        <div class="log-entry">
                            <small class="text-muted">Today, 2:30 PM</small>
                            <p class="mb-1">Video call ended - Duration: 15:32</p>
                        </div>
                        <div class="log-entry">
                            <small class="text-muted">Today, 10:15 AM</small>
                            <p class="mb-1">Video call started - Connected to Dr. Johnson</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow-lg">
                <div class="card-header bg-warning text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>
                        Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="takeScreenshot()">
                        <i class="fas fa-camera me-2"></i>Take Screenshot
                    </button>
                    <button class="btn btn-outline-info btn-sm w-100 mb-2" onclick="startRecording()">
                        <i class="fas fa-record-vinyl me-2"></i>Start Recording
                    </button>
                    <button class="btn btn-outline-success btn-sm w-100 mb-2" onclick="sendFile()">
                        <i class="fas fa-file-upload me-2"></i>Send File
                    </button>
                    <button class="btn btn-outline-warning btn-sm w-100" onclick="openChat()">
                        <i class="fas fa-comments me-2"></i>Open Chat
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- WebRTC Scripts -->
<script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
<script>
// WebRTC Variables
let localStream = null;
let remoteStream = null;
let peerConnection = null;
let localVideo = null;
let remoteVideo = null;
let isMuted = false;
let isVideoOff = false;
let isScreenSharing = false;
let callStartTime = null;
let callTimer = null;
let roomId = null;
let userId = null;
let screenStream = null;

// Initialize WebRTC
async function initializeWebRTC() {
    try {
        // Get user media (camera and microphone)
        localStream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: 'user'
            },
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }
        });

        // Display local video
        localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;

        // Hide overlay when video loads
        localVideo.onloadedmetadata = function() {
            document.getElementById('localVideoOverlay').style.display = 'none';
        };

        updateStatus('Camera and Microphone Ready', 'success');
        console.log('WebRTC initialized successfully');

    } catch (error) {
        console.error('Error accessing camera/microphone:', error);
        updateStatus('Camera/Microphone access denied', 'danger');
    }
}

// Start Video Call
async function startVideoCall() {
    try {
        if (!localStream) {
            await initializeWebRTC();
        }

        // Generate room and user IDs
        roomId = 'room_' + Date.now();
        userId = 'user_' + Date.now();

        // Create call room
        const response = await fetch('/api/calls/create-room', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                room_id: roomId,
                user_id: userId,
                call_type: 'video'
            })
        });

        if (response.ok) {
            // Start media stream
            await startMediaStream();

            // Update UI
            document.getElementById('startCallBtn').style.display = 'none';
            document.getElementById('endCallBtn').style.display = 'inline-block';
            document.getElementById('muteBtn').style.display = 'inline-block';
            document.getElementById('videoBtn').style.display = 'inline-block';
            document.getElementById('screenShareBtn').style.display = 'inline-block';

            // Start call timer
            startCallTimer();

            updateStatus('Video call in progress...', 'success');
            addCallLog('Video call started');

        } else {
            throw new Error('Failed to create call room');
        }

    } catch (error) {
        console.error('Error starting video call:', error);
        updateStatus('Failed to start video call', 'danger');
    }
}

// Start Media Stream
async function startMediaStream() {
    try {
        const response = await fetch('/api/calls/start-media', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId,
                room_id: roomId,
                media_type: 'both'
            })
        });

        if (response.ok) {
            console.log('Media stream started');
        } else {
            console.warn('Media stream start failed, continuing with local stream');
        }

    } catch (error) {
        console.error('Error starting media stream:', error);
    }
}

// End Video Call
async function endVideoCall() {
    try {
        if (roomId && userId) {
            // End call on server
            await fetch('/api/calls/end-call', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: userId,
                    room_id: roomId
                })
            });
        }

        // Stop local stream
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }

        // Stop screen share if active
        if (screenStream) {
            screenStream.getTracks().forEach(track => track.stop());
            screenStream = null;
        }

        // Reset UI
        document.getElementById('startCallBtn').style.display = 'inline-block';
        document.getElementById('endCallBtn').style.display = 'none';
        document.getElementById('muteBtn').style.display = 'none';
        document.getElementById('videoBtn').style.display = 'none';
        document.getElementById('screenShareBtn').style.display = 'none';

        // Stop timer
        stopCallTimer();

        updateStatus('Video call ended', 'warning');
        addCallLog('Video call ended');

        // Reset variables
        roomId = null;
        userId = null;

    } catch (error) {
        console.error('Error ending video call:', error);
    }
}

// Toggle Mute
function toggleMute() {
    if (localStream) {
        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            isMuted = !audioTrack.enabled;

            const muteBtn = document.getElementById('muteBtn');
            const muteText = document.getElementById('muteText');

            if (isMuted) {
                muteBtn.classList.remove('btn-warning');
                muteBtn.classList.add('btn-danger');
                muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                muteText.textContent = 'Unmute';
                updateStatus('Microphone muted', 'warning');
            } else {
                muteBtn.classList.remove('btn-danger');
                muteBtn.classList.add('btn-warning');
                muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                muteText.textContent = 'Mute';
                updateStatus('Microphone active', 'success');
            }
        }
    }
}

// Toggle Video
function toggleVideo() {
    if (localStream) {
        const videoTrack = localStream.getVideoTracks()[0];
        if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            isVideoOff = !videoTrack.enabled;

            const videoBtn = document.getElementById('videoBtn');
            const videoText = document.getElementById('videoText');

            if (isVideoOff) {
                videoBtn.classList.remove('btn-info');
                videoBtn.classList.add('btn-danger');
                videoBtn.innerHTML = '<i class="fas fa-video-slash"></i>';
                videoText.textContent = 'Video On';
                updateStatus('Camera turned off', 'warning');
            } else {
                videoBtn.classList.remove('btn-danger');
                videoBtn.classList.add('btn-info');
                videoBtn.innerHTML = '<i class="fas fa-video"></i>';
                videoText.textContent = 'Video Off';
                updateStatus('Camera active', 'success');
            }
        }
    }
}

// Toggle Screen Share
async function toggleScreenShare() {
    try {
        if (!isScreenSharing) {
            // Start screen sharing
            screenStream = await navigator.mediaDevices.getDisplayMedia({
                video: true,
                audio: true
            });

            // Replace video track
            const videoTrack = screenStream.getVideoTracks()[0];
            const sender = peerConnection?.getSenders().find(s => s.track?.kind === 'video');

            if (sender) {
                sender.replaceTrack(videoTrack);
            }

            // Update local video
            localVideo.srcObject = screenStream;

            isScreenSharing = true;
            document.getElementById('screenShareBtn').classList.remove('btn-secondary');
            document.getElementById('screenShareBtn').classList.add('btn-success');
            updateStatus('Screen sharing active', 'success');

        } else {
            // Stop screen sharing
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }

            // Restore camera
            localVideo.srcObject = localStream;

            isScreenSharing = false;
            document.getElementById('screenShareBtn').classList.remove('btn-success');
            document.getElementById('screenShareBtn').classList.add('btn-secondary');
            updateStatus('Screen sharing stopped', 'info');
        }

    } catch (error) {
        console.error('Error toggling screen share:', error);
        updateStatus('Screen sharing failed', 'danger');
    }
}

// Call Timer Functions
function startCallTimer() {
    callStartTime = Date.now();
    callTimer = setInterval(updateCallTimer, 1000);
    document.getElementById('callTimer').style.display = 'block';
}

function stopCallTimer() {
    if (callTimer) {
        clearInterval(callTimer);
        callTimer = null;
    }
    document.getElementById('callTimer').style.display = 'none';
}

function updateCallTimer() {
    const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('timerDisplay').textContent =
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Quick Action Functions
function takeScreenshot() {
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');

    if (remoteVideo.videoWidth > 0) {
        canvas.width = remoteVideo.videoWidth;
        canvas.height = remoteVideo.videoHeight;
        context.drawImage(remoteVideo, 0, 0);

        const link = document.createElement('a');
        link.download = `screenshot_${Date.now()}.png`;
        link.href = canvas.toDataURL();
        link.click();

        addCallLog('Screenshot taken');
    }
}

function startRecording() {
    // This would implement video recording functionality
    alert('Video recording feature would be implemented here');
}

function sendFile() {
    // This would implement file sharing functionality
    alert('File sharing feature would be implemented here');
}

function openChat() {
    // This would open the chat interface
    window.open('/chatbot', '_blank');
}

// Utility Functions
function updateStatus(message, type) {
    const statusText = document.getElementById('statusText');
    const statusIcon = document.getElementById('statusIcon');

    statusText.textContent = message;
    statusIcon.className = `fas fa-circle text-${type}`;
}

function addCallLog(message) {
    const callLogs = document.getElementById('callLogs');
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';

    const now = new Date();
    const timeString = now.toLocaleTimeString();

    logEntry.innerHTML = `
        <small class="text-muted">${timeString}</small>
        <p class="mb-1">${message}</p>
    `;

    callLogs.insertBefore(logEntry, callLogs.firstChild);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize WebRTC
    initializeWebRTC();
});

// Socket.IO connection for real-time updates
const socket = io();

socket.on('connect', function() {
    console.log('Connected to server');
});

socket.on('webrtc_answer', function(data) {
    console.log('Received WebRTC answer:', data);
    // Handle WebRTC answer
});

socket.on('ice_candidate', function(data) {
    console.log('Received ICE candidate:', data);
    // Handle ICE candidate
});

socket.on('call_ended', function(data) {
    console.log('Call ended by other party:', data);
    endVideoCall();
});
</script>

<style>
.video-container {
    background: #000;
    border-radius: 10px;
    padding: 20px;
}

.video-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
}

.video-label {
    color: #495057;
    margin-bottom: 10px;
    text-align: center;
}

.video-wrapper {
    position: relative;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
}

.video-wrapper video {
    width: 100%;
    height: 240px;
    object-fit: cover;
}

.video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
}

.call-status {
    padding: 2rem 0;
}

.status-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 1.2rem;
    font-weight: 600;
}

.call-controls {
    padding: 2rem 0;
}

.call-controls .btn {
    width: 80px;
    height: 80px;
    font-size: 1.5rem;
}

.quality-indicator {
    margin-bottom: 1rem;
}

.quality-indicator span {
    font-size: 0.9rem;
    color: #6c757d;
}

.info-item {
    padding: 0.5rem 0;
    border-bottom: 1px solid #e9ecef;
}

.info-item:last-child {
    border-bottom: none;
}

.call-logs {
    max-height: 200px;
    overflow-y: auto;
}

.log-entry {
    padding: 0.5rem 0;
    border-bottom: 1px solid #e9ecef;
}

.log-entry:last-child {
    border-bottom: none;
}

.progress {
    height: 8px;
}

.badge {
    font-size: 1rem;
    padding: 0.5rem 1rem;
}

.btn-sm {
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
}
</style>
{% endblock %}
