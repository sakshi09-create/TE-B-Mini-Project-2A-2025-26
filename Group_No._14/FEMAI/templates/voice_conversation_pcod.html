<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-Enabled PCOD Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }
        .chat-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 100%;
            height: 650px;
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .chat-header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white; padding: 20px; text-align: center;
        }
        .chat-header h1 { font-size: 1.5em; margin-bottom: 5px; }
        .language-selector { margin-top: 10px; }
        .language-selector select {
            padding: 5px 10px; border-radius: 5px; border: none; background: white; color: #333;
        }
        .form-container { flex: 1; padding: 20px; overflow-y: auto; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .input-wrapper { position: relative; display: flex; gap: 10px; align-items: center; }
        .form-group input, .form-group select {
            flex: 1; padding: 12px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 0.95em;
        }
        .voice-btn {
            width: 45px; height: 45px; border-radius: 50%; border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        .voice-btn:hover { transform: scale(1.1); box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
        .voice-btn.recording {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .submit-btn {
            width: 100%; background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; border: none; padding: 15px; border-radius: 15px;
            font-size: 1.1em; cursor: pointer; transition: all 0.3s ease;
        }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.4); }
        .feedback-message {
            margin-top: 5px; padding: 8px; border-radius: 5px; font-size: 0.9em;
            background: #d4edda; color: #155724; display: none;
        }
        .feedback-message.error { background: #f8d7da; color: #721c24; }
        .progress-bar { height: 4px; background: #e9ecef; border-radius: 2px; overflow: hidden; margin: 0 20px 20px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease; }
        .transcription-display {
            margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px;
            font-size: 0.85em; color: #666; font-style: italic; display: none;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>ü©∫ Voice PCOD Assistant</h1>
            <p>Speak or Type Your Answers</p>
            <div class="language-selector">
                <select id="languageSelect" onchange="setLanguage()">
                    <option value="hindi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                    <option value="english">English</option>
                    <option value="hinglish">Hinglish</option>
                </select>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>

        <div class="form-container">
            <form method="POST" action="/predict_pcod" id="pcodForm">
                <!-- Age -->
                <div class="form-group">
                    <label>Age (‡§â‡§Æ‡•ç‡§∞):</label>
                    <div class="input-wrapper">
                        <input type="number" name="age" id="age" required>
                        <button type="button" class="voice-btn" onclick="startVoiceInput('age', event)">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                    <div class="transcription-display" id="age-transcription"></div>
                    <div class="feedback-message" id="age-feedback"></div>
                </div>

                <!-- BMI -->
                <div class="form-group">
                    <label>BMI:</label>
                    <div class="input-wrapper">
                        <input type="number" name="bmi" id="bmi" step="0.1" required>
                        <button type="button" class="voice-btn" onclick="startVoiceInput('bmi', event)">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                    <div class="transcription-display" id="bmi-transcription"></div>
                    <div class="feedback-message" id="bmi-feedback"></div>
                </div>

                <!-- Irregular Periods -->
                <div class="form-group">
                    <label>Irregular Periods (‡§Ö‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§Æ‡§æ‡§π‡§µ‡§æ‡§∞‡•Ä):</label>
                    <div class="input-wrapper">
                        <select name="irregular" id="irregular" required>
                            <option value="">Select</option>
                            <option value="1">Yes (‡§π‡§æ‡§Ç)</option>
                            <option value="0">No (‡§®‡§π‡•Ä‡§Ç)</option>
                        </select>
                        <button type="button" class="voice-btn" onclick="startVoiceInput('irregular', event)">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                    <div class="transcription-display" id="irregular-transcription"></div>
                    <div class="feedback-message" id="irregular-feedback"></div>
                </div>

                <!-- Weight Gain -->
                <div class="form-group">
                    <label>Weight Gain (‡§µ‡§ú‡§® ‡§¨‡§¢‡§º‡§®‡§æ):</label>
                    <div class="input-wrapper">
                        <select name="weightgain" id="weightgain" required>
                            <option value="">Select</option>
                            <option value="1">Yes (‡§π‡§æ‡§Ç)</option>
                            <option value="0">No (‡§®‡§π‡•Ä‡§Ç)</option>
                        </select>
                        <button type="button" class="voice-btn" onclick="startVoiceInput('weightgain', event)">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                    <div class="transcription-display" id="weightgain-transcription"></div>
                    <div class="feedback-message" id="weightgain-feedback"></div>
                </div>

                <!-- Excess Hair Growth -->
                <div class="form-group">
                    <label>Excess Hair Growth (‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§¨‡§æ‡§≤):</label>
                    <div class="input-wrapper">
                        <select name="hairgrowth" id="hairgrowth" required>
                            <option value="">Select</option>
                            <option value="1">Yes (‡§π‡§æ‡§Ç)</option>
                            <option value="0">No (‡§®‡§π‡•Ä‡§Ç)</option>
                        </select>
                        <button type="button" class="voice-btn" onclick="startVoiceInput('hairgrowth', event)">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                    <div class="transcription-display" id="hairgrowth-transcription"></div>
                    <div class="feedback-message" id="hairgrowth-feedback"></div>
                </div>

                <!-- Acne -->
                <div class="form-group">
                    <label>Acne (‡§Æ‡•Å‡§π‡§æ‡§Ç‡§∏‡•á):</label>
                    <div class="input-wrapper">
                        <select name="acne" id="acne" required>
                            <option value="">Select</option>
                            <option value="1">Yes (‡§π‡§æ‡§Ç)</option>
                            <option value="0">No (‡§®‡§π‡•Ä‡§Ç)</option>
                        </select>
                        <button type="button" class="voice-btn" onclick="startVoiceInput('acne', event)">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                    <div class="transcription-display" id="acne-transcription"></div>
                    <div class="feedback-message" id="acne-feedback"></div>
                </div>

                <!-- Hair Loss -->
                <div class="form-group">
                    <label>Hair Loss (‡§¨‡§æ‡§≤ ‡§ó‡§ø‡§∞‡§®‡§æ):</label>
                    <div class="input-wrapper">
                        <select name="hairloss" id="hairloss" required>
                            <option value="">Select</option>
                            <option value="1">Yes (‡§π‡§æ‡§Ç)</option>
                            <option value="0">No (‡§®‡§π‡•Ä‡§Ç)</option>
                        </select>
                        <button type="button" class="voice-btn" onclick="startVoiceInput('hairloss', event)">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                    <div class="transcription-display" id="hairloss-transcription"></div>
                    <div class="feedback-message" id="hairloss-feedback"></div>
                </div>

                <!-- Family History -->
                <div class="form-group">
                    <label>Family History (‡§™‡§∞‡§ø‡§µ‡§æ‡§∞ ‡§ï‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏):</label>
                    <div class="input-wrapper">
                        <input type="number" name="family" id="family" required min="0" max="10">
                        <button type="button" class="voice-btn" onclick="startVoiceInput('family', event)">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                    <div class="transcription-display" id="family-transcription"></div>
                    <div class="feedback-message" id="family-feedback"></div>
                </div>

                <!-- Pain -->
                <div class="form-group">
                    <label>Pain (‡§¶‡§∞‡•ç‡§¶):</label>
                    <div class="input-wrapper">
                        <select name="pain" id="pain" required>
                            <option value="">Select</option>
                            <option value="1">Yes (‡§π‡§æ‡§Ç)</option>
                            <option value="0">No (‡§®‡§π‡•Ä‡§Ç)</option>
                        </select>
                        <button type="button" class="voice-btn" onclick="startVoiceInput('pain', event)">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                    <div class="transcription-display" id="pain-transcription"></div>
                    <div class="feedback-message" id="pain-feedback"></div>
                </div>

                <button type="submit" class="submit-btn">Get Prediction</button>
            </form>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let currentFieldId = null;

        async function startVoiceInput(fieldId, event) {
            currentFieldId = fieldId;
            const voiceBtn = event.target.closest('.voice-btn');
            const feedbackDiv = document.getElementById(`${fieldId}-feedback`);
            const transcriptionDiv = document.getElementById(`${fieldId}-transcription`);

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                voiceBtn.classList.add('recording');
                voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
                feedbackDiv.textContent = 'Recording... Click again to stop';
                feedbackDiv.classList.remove('error');
                feedbackDiv.style.display = 'block';

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await processAudio(audioBlob, fieldId);

                    voiceBtn.classList.remove('recording');
                    voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();

                // Auto-stop after 5 seconds
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
                }, 5000);

                voiceBtn.onclick = () => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
                };

            } catch (error) {
                console.error('Error accessing microphone:', error);
                feedbackDiv.textContent = 'Microphone access denied';
                feedbackDiv.classList.add('error');
                feedbackDiv.style.display = 'block';
                voiceBtn.classList.remove('recording');
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        }

        async function processAudio(audioBlob, fieldId) {
            const feedbackDiv = document.getElementById(`${fieldId}-feedback`);
            const transcriptionDiv = document.getElementById(`${fieldId}-transcription`);
            const inputField = document.getElementById(fieldId);

            feedbackDiv.textContent = 'Processing...';
            feedbackDiv.style.display = 'block';

            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.wav');
            formData.append('question_id', fieldId);
            formData.append('question_type', inputField.tagName === 'INPUT' ? 'number' : 'yes_no');

            try {
                const response = await fetch('/voice/process_audio', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    transcriptionDiv.textContent = `Heard: "${data.transcribed_text}"`;
                    transcriptionDiv.style.display = 'block';
                    inputField.value = data.extracted_value;
                    feedbackDiv.textContent = data.confirmation || 'Recorded';
                    feedbackDiv.classList.remove('error');
                    feedbackDiv.style.display = 'block';
                    updateProgress();
                } else {
                    transcriptionDiv.textContent = data.transcribed_text ? `Heard: "${data.transcribed_text}"` : '';
                    transcriptionDiv.style.display = data.transcribed_text ? 'block' : 'none';
                    feedbackDiv.textContent = data.error || 'Could not understand. Please try again.';
                    feedbackDiv.classList.add('error');
                    feedbackDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error processing audio:', error);
                feedbackDiv.textContent = 'Error processing audio. Please try again.';
                feedbackDiv.classList.add('error');
                feedbackDiv.style.display = 'block';
            }
        }

        function setLanguage() {
            const language = document.getElementById('languageSelect').value;
            fetch('/voice/set_language', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ language })
            })
            .then(res => res.json())
            .then(data => console.log('Language set to:', data.language))
            .catch(err => console.error('Error setting language:', err));
        }

        function updateProgress() {
            const fields = document.querySelectorAll('#pcodForm input, #pcodForm select');
            let filled = 0;
            fields.forEach(f => { if(f.value) filled++; });
            document.getElementById('progressFill').style.width = (filled / fields.length) * 100 + '%';
        }

        document.querySelectorAll('#pcodForm input, #pcodForm select').forEach(field => {
            field.addEventListener('input', updateProgress);
            field.addEventListener('change', updateProgress);
        });
    </script>
</body>
</html>
