{% extends "base.html" %}

{% block title %}Voice Call - FEMAI Health{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Call Interface -->
        <div class="col-lg-8">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-phone-alt me-2"></i>
                        Voice Call Interface
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Call Status -->
                    <div class="call-status text-center mb-4">
                        <div class="status-indicator" id="statusIndicator">
                            <i class="fas fa-circle text-warning" id="statusIcon"></i>
                            <span id="statusText">Ready to Call</span>
                        </div>
                        <div class="call-timer mt-2" id="callTimer" style="display: none;">
                            <span class="badge bg-success fs-6" id="timerDisplay">00:00</span>
                        </div>
                    </div>

                    <!-- Call Controls -->
                    <div class="call-controls text-center">
                        <div class="row justify-content-center">
                            <div class="col-auto">
                                <button class="btn btn-success btn-lg rounded-circle me-3" id="startCallBtn" onclick="startCall()">
                                    <i class="fas fa-phone-alt"></i>
                                </button>
                                <span class="d-block mt-2">Start Call</span>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-danger btn-lg rounded-circle me-3" id="endCallBtn" onclick="endCall()" style="display: none;">
                                    <i class="fas fa-phone-slash"></i>
                                </button>
                                <span class="d-block mt-2">End Call</span>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-warning btn-lg rounded-circle me-3" id="muteBtn" onclick="toggleMute()" style="display: none;">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <span class="d-block mt-2" id="muteText">Mute</span>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-info btn-lg rounded-circle" id="holdBtn" onclick="toggleHold()" style="display: none;">
                                    <i class="fas fa-pause"></i>
                                </button>
                                <span class="d-block mt-2" id="holdText">Hold</span>
                            </div>
                        </div>
                    </div>

                    <!-- Call Information -->
                    <div class="call-info mt-4">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-card">
                                    <h6><i class="fas fa-user-md me-2"></i>Healthcare Professional</h6>
                                    <p class="text-muted">{{ doctor.name }}</p>
                                    <p class="text-muted">{{ doctor.specialty }}</p>
                                    <p class="text-muted">
                                        <i class="fas fa-phone me-1"></i>{{ doctor.phone }}
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-card">
                                    <h6><i class="fas fa-clock me-2"></i>Available Hours</h6>
                                    <p class="text-muted">{{ doctor.available_hours }}</p>
                                    <p class="text-muted">{{ doctor.sat_hours }}</p>
                                    <p class="text-muted">
                                        <i class="fas fa-dollar-sign me-1"></i>{{ doctor.consultation_fee }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Call Quality Indicators -->
                    <div class="call-quality mt-4">
                        <h6><i class="fas fa-signal me-2"></i>Call Quality</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="quality-indicator">
                                    <span>Audio Quality:</span>
                                    <div class="progress mt-1">
                                        <div class="progress-bar bg-success" id="audioQuality" style="width: 85%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="quality-indicator">
                                    <span>Connection:</span>
                                    <div class="progress mt-1">
                                        <div class="progress-bar bg-info" id="connectionQuality" style="width: 90%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="quality-indicator">
                                    <span>Latency:</span>
                                    <div class="progress mt-1">
                                        <div class="progress-bar bg-warning" id="latencyQuality" style="width: 75%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Call Logs and Settings -->
        <div class="col-lg-4">
            <!-- Call Logs -->
            <div class="card shadow-lg mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Call Logs
                    </h6>
                </div>
                <div class="card-body">
                    <div class="call-logs" id="callLogs">
                        <div class="log-entry">
                            <small class="text-muted">Today, 2:30 PM</small>
                            <p class="mb-1">Call ended - Duration: 15:32</p>
                        </div>
                        <div class="log-entry">
                            <small class="text-muted">Today, 10:15 AM</small>
                            <p class="mb-1">Call started - Connected to Dr. Johnson</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Call Settings -->
            <div class="card shadow-lg">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Call Settings
                    </h6>
                </div>
                <div class="card-body">
                    <div class="setting-item mb-3">
                        <label class="form-label">Microphone Volume</label>
                        <input type="range" class="form-range" id="micVolume" min="0" max="100" value="80">
                        <small class="text-muted">Adjust microphone sensitivity</small>
                    </div>
                    <div class="setting-item mb-3">
                        <label class="form-label">Speaker Volume</label>
                        <input type="range" class="form-range" id="speakerVolume" min="0" max="100" value="70">
                        <small class="text-muted">Adjust speaker volume</small>
                    </div>
                    <div class="setting-item mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoRecord" checked>
                            <label class="form-check-label" for="autoRecord">
                                Auto-record calls
                            </label>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="noiseReduction" checked>
                            <label class="form-check-label" for="noiseReduction">
                                Noise reduction
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- WebRTC Scripts -->
<script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
<script>
// WebRTC Variables
let localStream = null;
let peerConnection = null;
let localAudio = null;
let isMuted = false;
let isOnHold = false;
let callStartTime = null;
let callTimer = null;
let roomId = null;
let userId = null;

// Initialize WebRTC
async function initializeWebRTC() {
    try {
        // Get user media (microphone)
        localStream = await navigator.mediaDevices.getUserMedia({
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }
        });

        localAudio = document.createElement('audio');
        localAudio.srcObject = localStream;
        localAudio.play();

        updateStatus('Microphone Ready', 'success');
        console.log('WebRTC initialized successfully');

    } catch (error) {
        console.error('Error accessing microphone:', error);
        updateStatus('Microphone access denied', 'danger');
    }
}

// Start Call
async function startCall() {
    try {
        if (!localStream) {
            await initializeWebRTC();
        }

        // Get doctor ID from URL or use default
        const urlParts = window.location.pathname.split('/');
        const doctorId = urlParts[urlParts.length - 1] || 'dr_sarah_johnson';

        // Generate user ID
        userId = 'user_' + Date.now();

        // Initiate call with doctor
        const response = await fetch('/api/calls/initiate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                doctor_id: doctorId,
                call_type: 'voice',
                user_id: userId
            })
        });

        if (response.ok) {
            const data = await response.json();
            roomId = data.room_id;

            // Create call room
            await fetch('/api/calls/create-room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    room_id: roomId,
                    user_id: userId,
                    doctor_id: doctorId,
                    call_type: 'voice'
                })
            });

            // Start media stream
            await startMediaStream();

            // Update UI
            document.getElementById('startCallBtn').style.display = 'none';
            document.getElementById('endCallBtn').style.display = 'inline-block';
            document.getElementById('muteBtn').style.display = 'inline-block';
            document.getElementById('holdBtn').style.display = 'inline-block';

            // Start call timer
            startCallTimer();

            updateStatus(`Call in progress with ${data.doctor.name}...`, 'success');
            addCallLog(`Call started with ${data.doctor.name}`);

            // Show doctor info
            showDoctorInfo(data.doctor);

        } else {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to initiate call');
        }

    } catch (error) {
        console.error('Error starting call:', error);
        updateStatus(`Failed to start call: ${error.message}`, 'danger');
    }
}

// Show doctor information during call
function showDoctorInfo(doctor) {
    const callInfo = document.querySelector('.call-info');
    callInfo.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="info-card">
                    <h6><i class="fas fa-user-md me-2"></i>Connected with</h6>
                    <p class="text-muted">${doctor.name}</p>
                    <p class="text-muted">${doctor.specialty}</p>
                    <p class="text-muted">
                        <i class="fas fa-phone me-1"></i>${doctor.phone}
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-card">
                    <h6><i class="fas fa-clock me-2"></i>Call Status</h6>
                    <p class="text-muted">Connected</p>
                    <p class="text-muted">Call in progress</p>
                    <p class="text-muted">
                        <i class="fas fa-signal me-1"></i>Good connection
                    </p>
                </div>
            </div>
        </div>
    `;
}

// Start Media Stream
async function startMediaStream() {
    try {
        const response = await fetch('/api/calls/start-media', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId,
                room_id: roomId,
                media_type: 'audio'
            })
        });

        if (response.ok) {
            console.log('Media stream started');
        } else {
            console.warn('Media stream start failed, continuing with local stream');
        }

    } catch (error) {
        console.error('Error starting media stream:', error);
    }
}

// End Call
async function endCall() {
    try {
        if (roomId && userId) {
            // End call on server
            await fetch('/api/calls/end-call', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: userId,
                    room_id: roomId
                })
            });
        }

        // Stop local stream
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }

        // Reset UI
        document.getElementById('startCallBtn').style.display = 'inline-block';
        document.getElementById('endCallBtn').style.display = 'none';
        document.getElementById('muteBtn').style.display = 'none';
        document.getElementById('holdBtn').style.display = 'none';

        // Stop timer
        stopCallTimer();

        updateStatus('Call ended', 'warning');
        addCallLog('Call ended');

        // Reset variables
        roomId = null;
        userId = null;

    } catch (error) {
        console.error('Error ending call:', error);
    }
}

// Toggle Mute
function toggleMute() {
    if (localStream) {
        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            isMuted = !audioTrack.enabled;

            const muteBtn = document.getElementById('muteBtn');
            const muteText = document.getElementById('muteText');

            if (isMuted) {
                muteBtn.classList.remove('btn-warning');
                muteBtn.classList.add('btn-danger');
                muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                muteText.textContent = 'Unmute';
                updateStatus('Microphone muted', 'warning');
            } else {
                muteBtn.classList.remove('btn-danger');
                muteBtn.classList.add('btn-warning');
                muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                muteText.textContent = 'Mute';
                updateStatus('Microphone active', 'success');
            }
        }
    }
}

// Toggle Hold
function toggleHold() {
    isOnHold = !isOnHold;

    const holdBtn = document.getElementById('holdBtn');
    const holdText = document.getElementById('holdText');

    if (isOnHold) {
        holdBtn.classList.remove('btn-info');
        holdBtn.classList.add('btn-warning');
        holdBtn.innerHTML = '<i class="fas fa-play"></i>';
        holdText.textContent = 'Resume';
        updateStatus('Call on hold', 'warning');
    } else {
        holdBtn.classList.remove('btn-warning');
        holdBtn.classList.add('btn-info');
        holdBtn.innerHTML = '<i class="fas fa-pause"></i>';
        holdText.textContent = 'Hold';
        updateStatus('Call resumed', 'success');
    }
}

// Call Timer Functions
function startCallTimer() {
    callStartTime = Date.now();
    callTimer = setInterval(updateCallTimer, 1000);
    document.getElementById('callTimer').style.display = 'block';
}

function stopCallTimer() {
    if (callTimer) {
        clearInterval(callTimer);
        callTimer = null;
    }
    document.getElementById('callTimer').style.display = 'none';
}

function updateCallTimer() {
    const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('timerDisplay').textContent =
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Utility Functions
function updateStatus(message, type) {
    const statusText = document.getElementById('statusText');
    const statusIcon = document.getElementById('statusIcon');

    statusText.textContent = message;
    statusIcon.className = `fas fa-circle text-${type}`;
}

function addCallLog(message) {
    const callLogs = document.getElementById('callLogs');
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';

    const now = new Date();
    const timeString = now.toLocaleTimeString();

    logEntry.innerHTML = `
        <small class="text-muted">${timeString}</small>
        <p class="mb-1">${message}</p>
    `;

    callLogs.insertBefore(logEntry, callLogs.firstChild);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize WebRTC
    initializeWebRTC();

    // Add event listeners for settings
    document.getElementById('micVolume').addEventListener('input', function() {
        // Adjust microphone volume
        if (localStream) {
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                // Note: Volume control requires additional Web Audio API implementation
                console.log('Microphone volume:', this.value);
            }
        }
    });

    document.getElementById('speakerVolume').addEventListener('input', function() {
        // Adjust speaker volume
        if (localAudio) {
            localAudio.volume = this.value / 100;
        }
    });
});

// Socket.IO connection for real-time updates
const socket = io();

socket.on('connect', function() {
    console.log('Connected to server');
});

socket.on('webrtc_answer', function(data) {
    console.log('Received WebRTC answer:', data);
    // Handle WebRTC answer
});

socket.on('ice_candidate', function(data) {
    console.log('Received ICE candidate:', data);
    // Handle ICE candidate
});

socket.on('call_ended', function(data) {
    console.log('Call ended by other party:', data);
    endCall();
});
</script>

<style>
.call-status {
    padding: 2rem 0;
}

.status-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 1.2rem;
    font-weight: 600;
}

.call-controls {
    padding: 2rem 0;
}

.call-controls .btn {
    width: 80px;
    height: 80px;
    font-size: 1.5rem;
}

.info-card {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 0.5rem;
    border-left: 4px solid #007bff;
}

.quality-indicator {
    margin-bottom: 1rem;
}

.quality-indicator span {
    font-size: 0.9rem;
    color: #6c757d;
}

.call-logs {
    max-height: 200px;
    overflow-y: auto;
}

.log-entry {
    padding: 0.5rem 0;
    border-bottom: 1px solid #e9ecef;
}

.log-entry:last-child {
    border-bottom: none;
}

.setting-item {
    padding: 0.5rem 0;
}

.progress {
    height: 8px;
}

.badge {
    font-size: 1rem;
    padding: 0.5rem 1rem;
}
</style>
{% endblock %}
