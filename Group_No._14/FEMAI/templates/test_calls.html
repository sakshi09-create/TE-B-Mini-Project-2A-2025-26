{% extends "base.html" %}

{% block title %}Test Calls - FEMAI Health{% endblock %}

{% block content %}
<div class="main-container">
    <div class="text-center mb-4">
        <h1 class="display-5 fw-bold text-primary">
            <i class="fas fa-vial me-3"></i>
            Call System Test
        </h1>
        <p class="lead text-muted">
            Test the voice and video calling functionality
        </p>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="feature-card">
                <h4><i class="fas fa-phone me-2"></i>Test Voice Call</h4>
                <p>Test the voice calling system with our doctors.</p>
                <div class="mb-3">
                    <label for="voiceDoctorSelect" class="form-label">Select Doctor:</label>
                    <select class="form-select" id="voiceDoctorSelect">
                        {% for doctor_id, doctor in doctors.items() %}
                        <option value="{{ doctor_id }}">{{ doctor.name }} - {{ doctor.specialty }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button class="btn btn-primary w-100" onclick="testVoiceCall()">
                    <i class="fas fa-phone me-2"></i>Test Voice Call
                </button>
            </div>
        </div>

        <div class="col-md-6">
            <div class="feature-card">
                <h4><i class="fas fa-video me-2"></i>Test Video Call</h4>
                <p>Test the video calling system with our doctors.</p>
                <div class="mb-3">
                    <label for="videoDoctorSelect" class="form-label">Select Doctor:</label>
                    <select class="form-select" id="videoDoctorSelect">
                        {% for doctor_id, doctor in doctors.items() %}
                        <option value="{{ doctor_id }}">{{ doctor.name }} - {{ doctor.specialty }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button class="btn btn-success w-100" onclick="testVideoCall()">
                    <i class="fas fa-video me-2"></i>Test Video Call
                </button>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="feature-card">
                <h4><i class="fas fa-info-circle me-2"></i>Test Results</h4>
                <div id="testResults" class="alert alert-info">
                    Click the test buttons above to see results here.
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="feature-card">
                <h4><i class="fas fa-cog me-2"></i>System Status</h4>
                <div class="row">
                    <div class="col-md-3">
                        <div class="status-item">
                            <i class="fas fa-server fa-2x text-primary"></i>
                            <h6>Server</h6>
                            <span class="badge bg-success">Online</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="status-item">
                            <i class="fas fa-database fa-2x text-info"></i>
                            <h6>Database</h6>
                            <span class="badge bg-success">Connected</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="status-item">
                            <i class="fas fa-microphone fa-2x text-warning"></i>
                            <h6>Audio</h6>
                            <span class="badge bg-warning">Testing</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="status-item">
                            <i class="fas fa-camera fa-2x text-warning"></i>
                            <h6>Video</h6>
                            <span class="badge bg-warning">Testing</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function testVoiceCall() {
    const doctorId = document.getElementById('voiceDoctorSelect').value;
    const resultsDiv = document.getElementById('testResults');
    
    resultsDiv.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin me-2"></i>
            Testing voice call with doctor ${doctorId}...
        </div>
    `;
    
    // Test the call initiation API
    fetch('/api/calls/initiate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            doctor_id: doctorId,
            call_type: 'voice',
            user_id: 'test_user_' + Date.now()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Voice call test successful!<br>
                    <strong>Room ID:</strong> ${data.room_id}<br>
                    <strong>Doctor:</strong> ${data.doctor.name}<br>
                    <strong>Message:</strong> ${data.message}
                </div>
            `;
        } else {
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Voice call test failed: ${data.message}
                </div>
            `;
        }
    })
    .catch(error => {
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error testing voice call: ${error.message}
            </div>
        `;
    });
}

function testVideoCall() {
    const doctorId = document.getElementById('videoDoctorSelect').value;
    const resultsDiv = document.getElementById('testResults');
    
    resultsDiv.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin me-2"></i>
            Testing video call with doctor ${doctorId}...
        </div>
    `;
    
    // Test the call initiation API
    fetch('/api/calls/initiate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            doctor_id: doctorId,
            call_type: 'video',
            user_id: 'test_user_' + Date.now()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Video call test successful!<br>
                    <strong>Room ID:</strong> ${data.room_id}<br>
                    <strong>Doctor:</strong> ${data.doctor.name}<br>
                    <strong>Message:</strong> ${data.message}
                </div>
            `;
        } else {
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Video call test failed: ${data.message}
                </div>
            `;
        }
    })
    .catch(error => {
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error testing video call: ${error.message}
            </div>
        `;
    });
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Call test page loaded');
});
</script>

<style>
.status-item {
    text-align: center;
    padding: 1rem;
}

.status-item i {
    margin-bottom: 1rem;
}

.status-item h6 {
    margin-bottom: 0.5rem;
    color: var(--dark-color);
}
</style>
{% endblock %}
